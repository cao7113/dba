#!/usr/bin/env ruby
require_relative '../boot'
class DbMigCLI < Thor
  class_option :debug, type: :boolean, aliases: [:d]

  desc 'init', 'init db project structure'
  def init
    # /xdbprj/    --current path
    # |------/db/
    # |------/db/init.rb
    # |------/db/migrate/
    # |------/db/seed.rb
    mig_path.mkpath
    puts "inited db prj at #{db_path}"
  end

  desc 'tree', 'migration files'
  def tree
    exec "tree #{db_path}"
  end

  desc 'test', 'test all'
  def test(tpath = Pathname(__dir__).join('../tmp/test-dbmigrate'))
    dbname = "dbmig_test#{Time.now.to_i}"
    dburl = "postgres://localhost/#{dbname}"
    adminurl = "postgres://localhost/postgres"
    puts "working path: #{tpath}"
    puts "target db: #{dburl} with #{adminurl}"

    cmds = <<~Desc
      # setup
      [ -d '#{tpath}' ] && rm -fr #{tpath} 
      mkdir -p #{tpath} && cd #{tpath}
      # try ops
      dbmigrate init
      dbmigrate generate create_todos
      dbmigrate initdb #{dbname} --adminurl #{adminurl}
      dbmigrate migrate #{dburl}
      dbmigrate tree
      # clean
      cat <<-SQL1 > sql123.sql
        drop database #{dbname}; 
        select datname from pg_catalog.pg_database;
      SQL1
      dbcli runsql sql123.sql #{adminurl} -l
      rm -f sql123.sql
    Desc
    if options[:debug]
      puts 
      puts "# run shell commands"
      puts cmds
    else
      system cmds
    end
  end

  desc 't1', ''
  def t1
    system <<~Desc
      cat <<-Abc > f11
        date
      Abc
      cat f11
      ls -l
      sh f11
      rm f11
      ls -l
    Desc
  end

  desc 'generate NAME', 'generate a migration file'
  option :edit, type: :boolean, aliases: [:e]
  def generate(migname)
    tmpl = DATA.read
    result = ERB.render(tmpl, binding)
    
    ts = Time.now.strftime("%Y%m%d%H%M%S")
    fname = "#{ts}_#{migname}.rb"
    fpath = mig_path.join(fname)
    fpath.write(result)
    puts "generated file: #{fpath.to_s}"
    exec "vi #{fpath.to_s}" if options[:edit]
  end

  desc 'ref', 'open ref doc'
  def ref
    puts "http://sequel.jeremyevans.net/documentation.html"
    cmd = "open http://sequel.jeremyevans.net/rdoc/files/doc/schema_modification_rdoc.html "
    puts cmd
    exec cmd
  end

  desc 'migrate [URL]', 'run migrations'
  option :version, banner: 'run to version, 0 to down all', aliases: [:v]
  def migrate(url = 'try', ver: nil)
    dburl = get_dburl(url)
    version = options[:version] || ver

    path = mig_path
    cmd = "sequel -m #{path.to_s}"
    cmd += " -M #{version}" if version
    cmd += " #{dburl}" 
    puts cmd
    #exec cmd
    %x( #{cmd} )
  end
  map "up" => "migrate"

  desc 'reset [URL]', 'reset db, rollback all migrations'
  def reset(url = 'try')
    invoke :up, [url], { version: 0 }
  end

  desc 'dump [URL]', 'dump db schema'
  def dump(url = 'try')
    dburl = get_dburl(url)
    cmd = "sequel -D #{dburl}" # use vendor specific
    puts cmd
    exec cmd
  end

  desc 'initdb DBNAME', 'init db'
  option :adminurl, default: 'default_admin', banner: 'admin url'
  def initdb(dbname)
    sql = "create database #{dbname};"
    ipath = db_path.join("init.sql")
    sql = ipath.read if ipath.exist?

    # todo use sequel internal way???
    url = options[:adminurl]
    dburl = get_dburl(url)
    conn = Dba::ConnectionBuilder.new(url: dburl)
    result = conn.run_sql(sql)
    puts "==run on #{dburl}:"
    puts sql
    puts result
  end

  desc 'seed [URL]', 'seed data'
  def seed(url = 'try')
    path = db_path.join('seed.rb')
    cmd = "#{path} #{url}"
    puts cmd
    system cmd
  end

  no_commands do
    def mig_path
      db_path.join('migrate')
    end

    def db_path
      Pathname.pwd.join('db')
    end

    def get_dburl(url)
      return url if Dba::Util.is_url?(url)
      `dbcli url #{url}`.chomp
    end
  end
end
DbMigCLI.start

__END__
# http://sequel.jeremyevans.net/rdoc/files/doc/schema_modification_rdoc.html
Sequel.migration do
  up do
    # extension :pg_enum
    create_table(:todos) do
      primary_key :id
      String :name, null: false
      DateTime :created_at, default: Sequel::CURRENT_TIMESTAMP #, :index=>true
      DateTime :updated_at, default: Sequel::CURRENT_TIMESTAMP
    end
  end

  down do
    drop_table(:todos)
  end
end
